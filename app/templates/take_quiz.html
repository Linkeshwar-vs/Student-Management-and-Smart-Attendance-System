{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="row">

    <!-- Sidebar -->
    <div class="col-md-3 mb-4">
      <h5>Questions</h5>
      <div class="d-flex flex-wrap">
        {% for qn in quiz.questions %}
          {% set ans = attempt.answers|selectattr('question_id','equalto',qn.id)|first %}
          <a href="{{ url_for('student.take_quiz', quiz_id=quiz.id, q=qn.index) }}"
             class="btn btn-sm me-2 mb-2
             {% if ans %}btn-success{% else %}btn-outline-danger{% endif %}">
            {{ qn.index }}
          </a>
        {% endfor %}
      </div>
    </div>

    <!-- Quiz Content -->
    <div class="col-md-9">
      <h3>{{ quiz.title }}</h3>
      <p>Question {{ idx }} of {{ total }}</p>

      <form id="quiz-form" method="POST" 
            action="{{ url_for('student.submit_answer') }}">
        <input type="hidden" name="attempt_id" value="{{ attempt.id }}">
        <input type="hidden" name="question_id" value="{{ question.id }}">

        <div class="mb-3">
          <strong>{{ question.stem }}</strong>
        </div>

        <div class="list-group mb-3">
          {% set chosen = attempt.answers|selectattr('question_id','equalto',question.id)|first %}
          {% for opt in question.options %}
            <label class="list-group-item">
              <input class="form-check-input me-1" type="radio" 
                     name="selected_idx" value="{{ opt.idx_char }}"
                {% if chosen and chosen.selected_option_id == opt.id %}checked{% endif %}>
              {{ opt.idx_char }}) {{ opt.text }}
            </label>
          {% endfor %}
        </div>

        <div class="d-flex justify-content-between">
          {% if idx > 1 %}
            <a class="btn btn-secondary"
               href="{{ url_for('student.take_quiz', quiz_id=quiz.id, q=idx-1) }}">Previous</a>
          {% else %}
            <span></span>
          {% endif %}
          {% if idx < total %}
            <button type="submit" class="btn btn-primary">Save & Next</button>
            <a class="btn btn-primary"
               href="{{ url_for('student.take_quiz', quiz_id=quiz.id, q=idx+1) }}">Next</a>
          {% else %}
            <button type="button" class="btn btn-success"
                    onclick="confirmSubmit()">Submit Quiz</button>
          {% endif %}
        </div>
      </form>

      {% if quiz.time_limit_seconds and quiz.time_limit_seconds>0 %}
      <div class="mt-3">
        <span id="timer" class="fw-bold"></span>
      </div>
      <script>
        let timeLeft = {{ quiz.time_limit_seconds }};
        const timerEl = document.getElementById('timer');
        let warned2 = false, warned1 = false;

        function tick(){
          let m = Math.floor(timeLeft/60), s = timeLeft % 60;
          timerEl.innerText = `Time Left: ${m}:${s.toString().padStart(2,'0')}`;
          if(timeLeft === 120 && !warned2){ alert("⚠️ 2 minutes left!"); warned2 = true; }
          if(timeLeft === 60 && !warned1){ alert("⚠️ 1 minute left!"); warned1 = true; }

          if(timeLeft > 0){ timeLeft--; setTimeout(tick,1000);}
          else { confirmSubmit(true); }
        }
        tick();

        function confirmSubmit(auto=false){
          if(auto || confirm("Submit quiz? You cannot change answers after.")){
            const form = document.getElementById('quiz-form');
            form.action = "{{ url_for('student.finish_attempt', attempt_id=attempt.id) }}";
            form.submit();
          }
        }
      </script>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
